<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Maerd â€“ Business Begins with a Dream</title>
  <style>
    /* existing styles omitted for brevity */
  </style>
</head>
<body>
  <div class="auth-container" id="authContainer">
    <div class="spectrum-strip"></div>
    <h1 id="form-title">Login to Maerd</h1>
    <input type="text" id="realName" placeholder="Your Real Name" style="display: none;" />
    <input type="text" id="businessName" placeholder="Business Name" style="display: none;" />
    <input type="email" id="email" placeholder="Email Address" />
    <input type="password" id="password" placeholder="Password" />
    <button id="actionButton">Login</button>
    <div class="toggle" id="toggleForm">Don't have an account? <span>Sign Up</span></div>
    <div class="bubble bubble1"></div>
    <div class="bubble bubble2"></div>
  </div>

  <div class="auth-container" id="verifyContainer" style="display:none;">
    <div class="spectrum-strip"></div>
    <h1>Email Verification</h1>
    <p>Please check your inbox for a verification link. Once verified, click 'I'm Verified' to continue.</p>
    <button id="resendButton">Resend Email</button>
    <button id="checkButton">I'm Verified</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, reload } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getDatabase, ref, set, update } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = { /* your config */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let isSignup = false;
    const toggleEl = document.getElementById('toggleForm');
    const actionBtn = document.getElementById('actionButton');
    const titleEl = document.getElementById('form-title');
    const realNameEl = document.getElementById('realName');
    const businessNameEl = document.getElementById('businessName');
    const authContainer = document.getElementById('authContainer');
    const verifyContainer = document.getElementById('verifyContainer');
    const resendBtn = document.getElementById('resendButton');
    const checkBtn = document.getElementById('checkButton');

    toggleEl.addEventListener('click', () => {
      isSignup = !isSignup;
      if (isSignup) {
        titleEl.textContent = 'Create Your Maerd Account';
        realNameEl.style.display = 'block';
        businessNameEl.style.display = 'block';
        actionBtn.textContent = 'Sign Up';
        toggleEl.innerHTML = 'Already have an account? <span>Login</span>';
      } else {
        titleEl.textContent = 'Login to Maerd';
        realNameEl.style.display = 'none';
        businessNameEl.style.display = 'none';
        actionBtn.textContent = 'Login';
        toggleEl.innerHTML = "Don't have an account? <span>Sign Up</span>";
      }
    });

    actionBtn.addEventListener('click', () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (isSignup) {
        const realName = realNameEl.value;
        const businessName = businessNameEl.value;
        createUserWithEmailAndPassword(auth, email, password)
          .then(userCred => {
            const uid = userCred.user.uid;
            // Initialize user data in Realtime Database
            const updates = {};
            updates['users/' + uid] = { realName, businessName, email };
            updates['wallets/' + uid] = { balance: 0 };
            updates['transactions/' + uid] = {};
            return update(ref(db), updates);
          })
          .then(() => sendEmailVerification(auth.currentUser))
          .then(() => {
            authContainer.style.display = 'none';
            verifyContainer.style.display = 'flex';
          })
          .catch(err => alert(err.message));
      } else {
        signInWithEmailAndPassword(auth, email, password)
          .catch(err => alert(err.message));
      }
    });

    resendBtn.addEventListener('click', () => {
      sendEmailVerification(auth.currentUser)
        .then(() => alert('Verification email resent.'))
        .catch(err => alert(err.message));
    });

    checkBtn.addEventListener('click', () => {
      reload(auth.currentUser).then(() => {
        if (auth.currentUser.emailVerified) {
          window.location.href = 'profile_setup.html';
        } else {
          alert('Email not verified yet.');
        }
      });
    });

    onAuthStateChanged(auth, user => {
      if (user && user.emailVerified && !isSignup) {
        window.location.href = 'feed.html';
      }
    });
  </script>
</body>
</html>
